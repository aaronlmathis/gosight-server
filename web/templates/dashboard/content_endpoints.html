{{ define "title" }}Endpoints{{ end }}
{{ template "dashboard/layout_endpoints" . }}

{{ define "content_endpoints" }}
<div class="space-y-4">
  <div class="mb-4">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Endpoints</h2>
    <p class="text-sm text-gray-500 dark:text-gray-400">Hosts and their active containers across your environment</p>
  </div>

  <div class="overflow-x-auto shadow rounded-lg border border-gray-200 dark:border-gray-700">
    <div class="flex flex-wrap gap-4 p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      <input id="filter-hostname" type="text" placeholder="Filter by Hostname"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <input id="filter-ip" type="text" placeholder="Filter by IP"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <input id="filter-os" type="text" placeholder="Filter by OS"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <input id="filter-arch" type="text" placeholder="Filter by Arch"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <select id="filter-status"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">All Statuses</option>
        <option value="online">Online</option>
        <option value="offline">Offline</option>
      </select>
    </div>
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-gray-700 text-xs text-gray-500 dark:text-gray-300">
        <tr>
          <th class="px-3 py-2 text-left cursor-pointer group" onclick="sortTableByColumn(0)">Status</th>
          <th class="px-3 py-2 text-left cursor-pointer group" onclick="sortTableByColumn(1)">Hostname</th>
          <th class="px-3 py-2 text-left cursor-pointer group" onclick="sortTableByColumn(2)">IP</th>
          <th class="px-3 py-2 text-left">OS</th>
          <th class="px-3 py-2 text-left">Platform</th>
          <th class="px-3 py-2 text-left">Architecture</th>
          <th class="px-3 py-2 text-left">Agent ID</th>
          <th class="px-3 py-2 text-left">Agent Version</th>
          <th class="px-3 py-2 text-left">Last Seen</th>
          <th class="px-3 py-2 text-left">Uptime</th>
          <th class="px-3 py-2 text-left">Expand</th>
        </tr>
      </thead>

      <tbody id="host-table-body" class="divide-y divide-gray-100 dark:divide-gray-800 text-sm">
        <!-- Rows are injected via JavaScript -->
      </tbody>
    </table>
  </div>


</div>
{{ end }}
{{ define "endpoint-scripts" }}

<script>
  async function loadHostTable() {
    const agentsRes = await fetch("/api/v1/agents");
    const agents = await agentsRes.json();

    const tbody = document.getElementById("host-table-body");
    tbody.innerHTML = "";

    for (const agent of agents) {
      const labels = agent.labels || {};
      const endpointID = agent.endpoint_id || "";
      const hname = agent.hostname;

      if (endpointID.startsWith("ctr-")) continue;

      const rowID = `host-${agent.agent_id}`;
      const isOnline = agent.status === "Online";

      const hostnameCell = isOnline
        ? `<a href="/endpoints/${endpointID}" class="text-blue-600 dark:text-blue-400 hover:underline">${hname}</a>`
        : `<span class="text-gray-500 dark:text-gray-400">${hname}</span>`;

      const expandCell = isOnline
        ? `<button onclick="toggleContainerRow('${hname}')" class="text-blue-500 hover:underline">
             <span id="expand-icon-${hname}" class="inline-block transform transition-transform">&#9654;</span>
           </button>`
        : `<span class="text-gray-400">‚Äî</span>`;

      const platform = `${labels.platform || ""} ${labels.platform_version || ""}`.trim();

      const hostRowHTML = `
<tr id="${rowID}" class="hover:bg-gray-50 dark:hover:bg-gray-800 host-row">
  <td class="px-3 py-2">
    ${isOnline
          ? '<span class="text-green-500 font-medium">‚óè Online</span>'
          : '<span class="text-red-500 font-medium">‚óè Offline</span>'}
  </td>
  <td class="px-3 py-2 font-medium">${hostnameCell}</td>
  <td class="px-3 py-2">${agent.ip}</td>
  <td class="px-3 py-2">${agent.os}</td>
  <td class="px-3 py-2">${platform}</td>
  <td class="px-3 py-2">${agent.arch}</td>
  <td class="px-3 py-2">${agent.agent_id}</td>
  <td class="px-3 py-2">${agent.version}</td>
  <td class="px-3 py-2" id="lastseen-${rowID}">‚Äî</td>
  <td class="px-3 py-2" id="uptime-${rowID}">‚Äî</td>
  <td class="px-3 py-2">${expandCell}</td>
</tr>
<tr id="containers-${hname}" class="container-subtable hidden bg-gray-50 dark:bg-gray-800">
  <td colspan="12" class="px-4 py-3 text-sm text-gray-400">Loading containers‚Ä¶</td>
</tr>
      `;

      tbody.insertAdjacentHTML("beforeend", hostRowHTML);

      // ‚úÖ Update last seen / uptime AFTER inserting row
      const lastSeenCell = document.getElementById(`lastseen-${rowID}`);
      const uptimeCell = document.getElementById(`uptime-${rowID}`);

      if (isOnline) {
        if (uptimeCell) uptimeCell.textContent = formatUptime(agent.uptime_seconds);
        if (lastSeenCell) lastSeenCell.textContent = "‚Äî";
      } else {
        if (lastSeenCell) lastSeenCell.textContent = formatLastSeen(agent.last_seen);
        if (uptimeCell) uptimeCell.textContent = "‚Äî";
      }
    }
  }

  function formatLastSeen(isoTime) {
    if (!isoTime) return "‚Äî";
    const last = new Date(isoTime).getTime();
    const now = Date.now();
    const diff = Math.floor((now - last) / 1000);

    console.log("üïê now:", new Date(now).toISOString());
    console.log("üïì last_seen:", new Date(isoTime).toISOString());
    console.log("‚è±Ô∏è diff (s):", diff);

    if (diff < 60) return `${diff}s ago`;
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
  }
  function formatUptime(seconds) {
    const s = Math.floor(seconds);
    const d = Math.floor(s / 86400);
    const h = Math.floor((s % 86400) / 3600);
    const m = Math.floor((s % 3600) / 60);
    return `${d > 0 ? d + 'd ' : ''}${h}h ${m}m`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadHostTable();
  });
</script>
<script>
  function toggleContainerRow(hostname) {
    const row = document.getElementById(`containers-${hostname}`);
    const icon = document.getElementById(`expand-icon-${hostname}`);
    const metrics = [
      "container.podman.cpu_percent",
      "container.podman.mem_usage_bytes",
      "container.podman.net_rx_bytes",
      "container.podman.net_tx_bytes",
      "container.podman.uptime_seconds"
    ];
    const query = metrics.map(m => `metric=${m}`).join("&") + `&hostname=${encodeURIComponent(hostname)}`;

    if (!row) return;

    const expanded = !row.classList.contains("hidden");
    row.classList.toggle("hidden");
    icon.classList.toggle("rotate-90");

    if (!expanded && !row.dataset.loaded) {
      row.innerHTML = `<td colspan="13" class="p-4 text-gray-400">Loading...</td>`;

      fetch(`/api/v1/query?${query}`)
        .then(res => res.json())
        .then(json => {
          const rows = Array.isArray(json) ? json : [];
          console.log("üì¶ Raw container metrics:", rows);
          const grouped = groupContainers(rows);
          console.log("üß© Grouped containers:", grouped);
          row.innerHTML = `<td colspan="13" class="p-4">${buildContainerTable(grouped)}</td>`;
          row.dataset.loaded = "true";
        })
        .catch(err => {
          console.error("‚ùå Failed to fetch containers:", err);
          row.innerHTML = `<td colspan="13" class="p-4 text-red-500">Container fetch failed: ${err}</td>`;
        });
    }
  }

  function groupContainers(rows) {
    if (!Array.isArray(rows)) return [];
    const map = {};

    rows.forEach(row => {
      const tags = row.tags || {};
      const id = tags.container_id;

      console.log("‚û°Ô∏è Checking row with container_id:", id, "name:", tags["__name__"]);

      if (!id) {
        console.warn("‚ùå Skipping row: missing container_id", row);
        return;
      }

      if (!map[id]) {
        map[id] = {
          name: tags.container_name || "‚Äî",
          image: tags.image_id || "‚Äî",
          status: tags.status || "unknown",
          cpu: "‚Äî",
          mem: "‚Äî",
          rx: "‚Äî",
          tx: "‚Äî",
          uptime: "‚Äî",
        };
      }

      const metricName = tags["__name__"] || "";
      const value = row.value;

      switch (metricName) {
        case "container.podman.cpu_percent":
          map[id].cpu = `${value.toFixed(1)}%`;
          break;
        case "container.podman.mem_usage_bytes":
          map[id].mem = formatBytes(value);
          break;
        case "container.podman.net_rx_bytes":
          map[id].rx = formatBytes(value);
          break;
        case "container.podman.net_tx_bytes":
          map[id].tx = formatBytes(value);
          break;
        case "container.podman.uptime_seconds":
          map[id].uptime = formatUptime(value);
          break;
      }
    });

    return Object.values(map);
  }

  function buildContainerTable(containers) {
    if (!containers.length)
      return `<p class="text-sm italic text-gray-400">No containers found.</p>`;

    const rows = containers.map((c, i) => `
<tr class="${i % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'} hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
  <td class="px-4 py-2">${statusBadge(c.status)}</td>
  <td class="px-4 py-2 font-medium text-blue-600 dark:text-blue-400 hover:underline cursor-pointer">${c.name}</td>
  <td class="px-4 py-2 text-gray-700 dark:text-gray-300">${c.image}</td>
  <td class="px-4 py-2 text-right">${c.cpu}</td>
  <td class="px-4 py-2 text-right">${c.mem}</td>
  <td class="px-4 py-2 text-right">${c.rx}</td>
  <td class="px-4 py-2 text-right">${c.tx}</td>
  <td class="px-4 py-2 text-right">${c.uptime}</td>
</tr>
`).join("");

    return `
<div class="overflow-x-auto border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm">
  <table class="min-w-full text-sm text-left">
    <thead class="text-xs uppercase text-gray-500 bg-gray-100 dark:bg-gray-700 dark:text-gray-300">
      <tr>
        <th class="px-4 py-2">Status</th>
        <th class="px-4 py-2">Name</th>
        <th class="px-4 py-2">Image</th>
        <th class="px-4 py-2 text-right">CPU %</th>
        <th class="px-4 py-2 text-right">Mem</th>
        <th class="px-4 py-2 text-right">RX</th>
        <th class="px-4 py-2 text-right">TX</th>
        <th class="px-4 py-2 text-right">Uptime</th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  </table>
</div>
`;
  }

  function formatBytes(bytes) {
    if (!bytes || isNaN(bytes)) return "‚Äî";
    const units = ["B", "KB", "MB", "GB"];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) {
      bytes /= 1024;
      i++;
    }
    return `${bytes.toFixed(1)} ${units[i]}`;
  }

  function statusBadge(status) {
    if (status === "running")
      return `<span class="px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">running</span>`;
    return `<span class="px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100">stopped</span>`;
  }
</script>

{{ end }}