{{ define "title" }}Endpoints{{ end }}
{{ template "dashboard/layout_endpoints" . }}

{{ define "content_endpoints" }}
<div class="space-y-4">
  <div class="mb-4">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Endpoints</h2>
    <p class="text-sm text-gray-500 dark:text-gray-400">Hosts and their active containers across your environment</p>
  </div>

  <div class="overflow-x-auto shadow rounded-lg border border-gray-200 dark:border-gray-700">
    <div class="flex flex-wrap gap-4 p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      <input id="filter-hostname" type="text" placeholder="Filter by Hostname"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <input id="filter-ip" type="text" placeholder="Filter by IP"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <input id="filter-os" type="text" placeholder="Filter by OS"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <input id="filter-arch" type="text" placeholder="Filter by Arch"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <select id="filter-status"
        class="text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">All Statuses</option>
        <option value="online">Online</option>
        <option value="offline">Offline</option>
      </select>
    </div>
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-gray-700 text-xs text-gray-500 dark:text-gray-300">
        <tr>
          <th class="px-3 py-2 text-left cursor-pointer group" onclick="sortTableByColumn(0)">Status</th>
          <th class="px-3 py-2 text-left cursor-pointer group" onclick="sortTableByColumn(1)">Hostname</th>
          <th class="px-3 py-2 text-left cursor-pointer group" onclick="sortTableByColumn(2)">IP</th>
          <th class="px-3 py-2 text-left">OS</th>
          <th class="px-3 py-2 text-left">Platform</th>
          <th class="px-3 py-2 text-left">Architecture</th>
          <th class="px-3 py-2 text-left">Agent ID</th>
          <th class="px-3 py-2 text-left">Agent Version</th>
          <th class="px-3 py-2 text-left">Last Seen</th>
          <th class="px-3 py-2 text-left">Uptime</th>
          <th class="px-3 py-2 text-left">Expand</th>
        </tr>
      </thead>

      <tbody id="host-table-body" class="divide-y divide-gray-100 dark:divide-gray-800 text-sm">
        <!-- Rows are injected via JavaScript -->
      </tbody>
    </table>
  </div>


</div>
{{ end }}
{{ define "endpoint-scripts" }}

<script>
  async function loadHostTable() {
    const agentsRes = await fetch("/api/v1/agents");
    const agents = await agentsRes.json();

    const tbody = document.getElementById("host-table-body");
    tbody.innerHTML = "";

    for (const agent of agents) {
      const labels = agent.labels || {};
      const endpointID = agent.endpoint_id || "";
      const hname = agent.hostname;

      if (endpointID.startsWith("ctr-")) continue;

      const rowID = `host-${agent.agent_id}`;
      const isOnline = agent.status === "Online";

      const hostnameCell = isOnline
        ? `<a href="/endpoints/${endpointID}" class="text-blue-600 dark:text-blue-400 hover:underline">${hname}</a>`
        : `<span class="text-gray-500 dark:text-gray-400">${hname}</span>`;

      const expandCell = isOnline
        ? `<button onclick="toggleContainerRow('${hname}')" class="text-blue-500 hover:underline">
             <span id="expand-icon-${hname}" class="inline-block transform transition-transform">&#9654;</span>
           </button>`
        : `<span class="text-gray-400">‚Äî</span>`;

      const platform = `${labels.platform || ""} ${labels.platform_version || ""}`.trim();

      const hostRowHTML = `
<tr id="${rowID}" class="hover:bg-gray-50 dark:hover:bg-gray-800 host-row">
  <td class="px-3 py-2">
    ${isOnline
          ? '<span class="text-green-500 font-medium">‚óè Online</span>'
          : '<span class="text-red-500 font-medium">‚óè Offline</span>'}
  </td>
  <td class="px-3 py-2 font-medium">${hostnameCell}</td>
  <td class="px-3 py-2">${agent.ip}</td>
  <td class="px-3 py-2">${agent.os}</td>
  <td class="px-3 py-2">${platform}</td>
  <td class="px-3 py-2">${agent.arch}</td>
  <td class="px-3 py-2">${agent.agent_id}</td>
  <td class="px-3 py-2">${agent.version}</td>
  <td class="px-3 py-2" id="lastseen-${rowID}">‚Äî</td>
  <td class="px-3 py-2" id="uptime-${rowID}">‚Äî</td>
  <td class="px-3 py-2">${expandCell}</td>
</tr>
<tr id="containers-${hname}" class="container-subtable hidden bg-gray-50 dark:bg-gray-800">
  <td colspan="12" class="px-4 py-3 text-sm text-gray-400">Loading containers‚Ä¶</td>
</tr>
      `;

      tbody.insertAdjacentHTML("beforeend", hostRowHTML);

      // ‚úÖ Update last seen / uptime AFTER inserting row
      const lastSeenCell = document.getElementById(`lastseen-${rowID}`);
      const uptimeCell = document.getElementById(`uptime-${rowID}`);

      if (isOnline) {
        if (uptimeCell) uptimeCell.textContent = formatUptime(agent.uptime_seconds);
        if (lastSeenCell) lastSeenCell.textContent = "‚Äî";
      } else {
        if (lastSeenCell) lastSeenCell.textContent = formatLastSeen(agent.last_seen);
        if (uptimeCell) uptimeCell.textContent = "‚Äî";
      }
    }
  }

  function formatLastSeen(isoTime) {
    if (!isoTime) return "‚Äî";
    const last = new Date(isoTime).getTime();
    const now = Date.now();
    const diff = Math.floor((now - last) / 1000);

    console.log("üïê now:", new Date(now).toISOString());
    console.log("üïì last_seen:", new Date(isoTime).toISOString());
    console.log("‚è±Ô∏è diff (s):", diff);

    if (diff < 60) return `${diff}s ago`;
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
  }
  function formatUptime(seconds) {
    const s = Math.floor(seconds);
    const d = Math.floor(s / 86400);
    const h = Math.floor((s % 86400) / 3600);
    const m = Math.floor((s % 3600) / 60);
    return `${d > 0 ? d + 'd ' : ''}${h}h ${m}m`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadHostTable();
  });
</script>


{{ end }}