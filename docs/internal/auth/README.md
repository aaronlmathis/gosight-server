<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# gosightauth

```go
import "github.com/aaronlmathis/gosight-server/internal/auth"
```

local.go: Handles login, registration, password validation.

mfa.go: Uses TOTP to generate QR codes/secrets and verify codes.

session.go: Handles signed cookies or token generation/validation.

## Index

- [Variables](<#variables>)
- [func AccessLogMiddleware\(next http.Handler\) http.Handler](<#AccessLogMiddleware>)
- [func AuthMiddleware\(userStore userstore.UserStore\) mux.MiddlewareFunc](<#AuthMiddleware>)
- [func CheckPasswordHash\(password, hash string\) bool](<#CheckPasswordHash>)
- [func CheckRememberMFA\(r \*http.Request, userID string\) bool](<#CheckRememberMFA>)
- [func ClearCookie\(w http.ResponseWriter, name string\)](<#ClearCookie>)
- [func ClearRememberMFA\(w http.ResponseWriter\)](<#ClearRememberMFA>)
- [func ExtractRoleNames\(roles \[\]usermodel.Role\) \[\]string](<#ExtractRoleNames>)
- [func FlattenPermissions\(roles \[\]usermodel.Role\) \[\]string](<#FlattenPermissions>)
- [func GenerateTOTPSecret\(email string\) \(string, error\)](<#GenerateTOTPSecret>)
- [func GenerateToken\(userID string, roles \[\]string, traceID string\) \(string, error\)](<#GenerateToken>)
- [func GetSessionToken\(r \*http.Request\) \(string, error\)](<#GetSessionToken>)
- [func GetSessionUserID\(r \*http.Request\) \(string, error\)](<#GetSessionUserID>)
- [func HasAnyPermission\(ctx context.Context, required ...string\) bool](<#HasAnyPermission>)
- [func HasAnyRole\(roles \[\]string, requiredRoles ...string\) bool](<#HasAnyRole>)
- [func HasPermission\(ctx context.Context, required string\) bool](<#HasPermission>)
- [func HasRole\(roles \[\]string, required string\) bool](<#HasRole>)
- [func HashPassword\(password string\) \(string, error\)](<#HashPassword>)
- [func InitJWTSecret\(encoded string\) error](<#InitJWTSecret>)
- [func InitMFAKey\(encoded string\) error](<#InitMFAKey>)
- [func InjectSessionContext\(ctx context.Context, user \*usermodel.User\) context.Context](<#InjectSessionContext>)
- [func LoadPendingMFA\(r \*http.Request\) \(string, error\)](<#LoadPendingMFA>)
- [func RequireAnyPermissionWithStore\(store userstore.UserStore, required ...string\) func\(http.Handler\) http.Handler](<#RequireAnyPermissionWithStore>)
- [func RequirePermission\(required string, next http.Handler, userStore userstore.UserStore\) http.Handler](<#RequirePermission>)
- [func SavePendingMFA\(userID string, w http.ResponseWriter\)](<#SavePendingMFA>)
- [func SetRememberMFA\(w http.ResponseWriter, userID string, r \*http.Request\)](<#SetRememberMFA>)
- [func SetSessionCookie\(w http.ResponseWriter, token string\)](<#SetSessionCookie>)
- [func ValidateTOTP\(secret, code string\) bool](<#ValidateTOTP>)
- [type AuthProvider](<#AuthProvider>)
- [type GoogleAuth](<#GoogleAuth>)
  - [func \(g \*GoogleAuth\) HandleCallback\(w http.ResponseWriter, r \*http.Request\) \(\*usermodel.User, error\)](<#GoogleAuth.HandleCallback>)
  - [func \(g \*GoogleAuth\) StartLogin\(w http.ResponseWriter, r \*http.Request\)](<#GoogleAuth.StartLogin>)
- [type LocalAuth](<#LocalAuth>)
  - [func \(l \*LocalAuth\) HandleCallback\(w http.ResponseWriter, r \*http.Request\) \(\*usermodel.User, error\)](<#LocalAuth.HandleCallback>)
  - [func \(l \*LocalAuth\) StartLogin\(w http.ResponseWriter, r \*http.Request\)](<#LocalAuth.StartLogin>)
- [type SessionClaims](<#SessionClaims>)
  - [func GetSessionClaims\(r \*http.Request\) \(\*SessionClaims, error\)](<#GetSessionClaims>)
  - [func ValidateToken\(tokenStr string\) \(\*SessionClaims, error\)](<#ValidateToken>)


## Variables

<a name="ErrInvalidPassword"></a>

```go
var (
    ErrInvalidPassword = errors.New("invalid password")
    ErrInvalidTOTP     = errors.New("invalid TOTP code")
    ErrUserNotFound    = errors.New("user not found")
    ErrUnauthorized    = errors.New("unauthorized")
)
```

<a name="ErrNoSession"></a>

```go
var ErrNoSession = errors.New("no session token found")
```

<a name="AccessLogMiddleware"></a>
## func [AccessLogMiddleware](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/middleware.go#L165>)

```go
func AccessLogMiddleware(next http.Handler) http.Handler
```



<a name="AuthMiddleware"></a>
## func [AuthMiddleware](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/middleware.go#L91>)

```go
func AuthMiddleware(userStore userstore.UserStore) mux.MiddlewareFunc
```



<a name="CheckPasswordHash"></a>
## func [CheckPasswordHash](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/password.go#L10>)

```go
func CheckPasswordHash(password, hash string) bool
```



<a name="CheckRememberMFA"></a>
## func [CheckRememberMFA](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/mfa.go#L114>)

```go
func CheckRememberMFA(r *http.Request, userID string) bool
```



<a name="ClearCookie"></a>
## func [ClearCookie](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L117>)

```go
func ClearCookie(w http.ResponseWriter, name string)
```

ClearCookie clears a cookie by setting its MaxAge to \-1 and Expiration to the past

<a name="ClearRememberMFA"></a>
## func [ClearRememberMFA](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/mfa.go#L166>)

```go
func ClearRememberMFA(w http.ResponseWriter)
```



<a name="ExtractRoleNames"></a>
## func [ExtractRoleNames](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/common.go#L19>)

```go
func ExtractRoleNames(roles []usermodel.Role) []string
```



<a name="FlattenPermissions"></a>
## func [FlattenPermissions](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/common.go#L5>)

```go
func FlattenPermissions(roles []usermodel.Role) []string
```



<a name="GenerateTOTPSecret"></a>
## func [GenerateTOTPSecret](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/mfa.go#L33>)

```go
func GenerateTOTPSecret(email string) (string, error)
```

TOTP MFA

<a name="GenerateToken"></a>
## func [GenerateToken](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L34>)

```go
func GenerateToken(userID string, roles []string, traceID string) (string, error)
```



<a name="GetSessionToken"></a>
## func [GetSessionToken](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L85>)

```go
func GetSessionToken(r *http.Request) (string, error)
```

GetSessionToken retrieves the session token from cookie or header

<a name="GetSessionUserID"></a>
## func [GetSessionUserID](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L108>)

```go
func GetSessionUserID(r *http.Request) (string, error)
```

Convenience: get user ID from session token in request

<a name="HasAnyPermission"></a>
## func [HasAnyPermission](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/permission.go#L30>)

```go
func HasAnyPermission(ctx context.Context, required ...string) bool
```



<a name="HasAnyRole"></a>
## func [HasAnyRole](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/permission.go#L56>)

```go
func HasAnyRole(roles []string, requiredRoles ...string) bool
```



<a name="HasPermission"></a>
## func [HasPermission](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/permission.go#L11>)

```go
func HasPermission(ctx context.Context, required string) bool
```

HasPermission checks if the current context includes the given permission

<a name="HasRole"></a>
## func [HasRole](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/permission.go#L47>)

```go
func HasRole(roles []string, required string) bool
```



<a name="HashPassword"></a>
## func [HashPassword](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/password.go#L6>)

```go
func HashPassword(password string) (string, error)
```

Password Utilities

<a name="InitJWTSecret"></a>
## func [InitJWTSecret](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L25>)

```go
func InitJWTSecret(encoded string) error
```



<a name="InitMFAKey"></a>
## func [InitMFAKey](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/mfa.go#L23>)

```go
func InitMFAKey(encoded string) error
```



<a name="InjectSessionContext"></a>
## func [InjectSessionContext](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/context.go#L11>)

```go
func InjectSessionContext(ctx context.Context, user *usermodel.User) context.Context
```



<a name="LoadPendingMFA"></a>
## func [LoadPendingMFA](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/mfa.go#L49>)

```go
func LoadPendingMFA(r *http.Request) (string, error)
```

LoadPendingMFA retrieves the pending MFA cookie

<a name="RequireAnyPermissionWithStore"></a>
## func [RequireAnyPermissionWithStore](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/middleware.go#L58>)

```go
func RequireAnyPermissionWithStore(store userstore.UserStore, required ...string) func(http.Handler) http.Handler
```



<a name="RequirePermission"></a>
## func [RequirePermission](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/middleware.go#L18>)

```go
func RequirePermission(required string, next http.Handler, userStore userstore.UserStore) http.Handler
```



<a name="SavePendingMFA"></a>
## func [SavePendingMFA](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/mfa.go#L64>)

```go
func SavePendingMFA(userID string, w http.ResponseWriter)
```

SavePendingMFA sets a cookie to remember the pending MFA for 5 minutes

<a name="SetRememberMFA"></a>
## func [SetRememberMFA](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/mfa.go#L77>)

```go
func SetRememberMFA(w http.ResponseWriter, userID string, r *http.Request)
```

SetRememberMFA sets a cookie to remember the MFA for 30 days \- bind it to device

<a name="SetSessionCookie"></a>
## func [SetSessionCookie](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L70>)

```go
func SetSessionCookie(w http.ResponseWriter, token string)
```



<a name="ValidateTOTP"></a>
## func [ValidateTOTP](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/mfa.go#L44>)

```go
func ValidateTOTP(secret, code string) bool
```



<a name="AuthProvider"></a>
## type [AuthProvider](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/provider.go#L13-L16>)



```go
type AuthProvider interface {
    StartLogin(w http.ResponseWriter, r *http.Request)
    HandleCallback(w http.ResponseWriter, r *http.Request) (*usermodel.User, error)
}
```

<a name="GoogleAuth"></a>
## type [GoogleAuth](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/google.go#L19-L22>)



```go
type GoogleAuth struct {
    OAuthConfig *oauth2.Config
    Store       userstore.UserStore
}
```

<a name="GoogleAuth.HandleCallback"></a>
### func \(\*GoogleAuth\) [HandleCallback](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/google.go#L35>)

```go
func (g *GoogleAuth) HandleCallback(w http.ResponseWriter, r *http.Request) (*usermodel.User, error)
```



<a name="GoogleAuth.StartLogin"></a>
### func \(\*GoogleAuth\) [StartLogin](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/google.go#L24>)

```go
func (g *GoogleAuth) StartLogin(w http.ResponseWriter, r *http.Request)
```



<a name="LocalAuth"></a>
## type [LocalAuth](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/local.go#L12-L14>)



```go
type LocalAuth struct {
    Store userstore.UserStore
}
```

<a name="LocalAuth.HandleCallback"></a>
### func \(\*LocalAuth\) [HandleCallback](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/local.go#L22>)

```go
func (l *LocalAuth) HandleCallback(w http.ResponseWriter, r *http.Request) (*usermodel.User, error)
```



<a name="LocalAuth.StartLogin"></a>
### func \(\*LocalAuth\) [StartLogin](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/local.go#L16>)

```go
func (l *LocalAuth) StartLogin(w http.ResponseWriter, r *http.Request)
```



<a name="SessionClaims"></a>
## type [SessionClaims](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L17-L23>)



```go
type SessionClaims struct {
    UserID           string   `json:"sub"`
    Roles            []string `json:"roles,omitempty"`
    TraceID          string   `json:"trace_id,omitempty"`
    RolesRefreshedAt int64    `json:"roles_refreshed_at"`
    jwt.RegisteredClaims
}
```

<a name="GetSessionClaims"></a>
### func [GetSessionClaims](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L99>)

```go
func GetSessionClaims(r *http.Request) (*SessionClaims, error)
```

GetSessionClaims retrieves the session claims from the request

<a name="ValidateToken"></a>
### func [ValidateToken](<https://github.com/aaronlmathis/gosight-server/blob/main/internal/auth/session.go#L51>)

```go
func ValidateToken(tokenStr string) (*SessionClaims, error)
```



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
